version: '3.8'

services:
  # ==================== API GATEWAY ====================
  api-gateway:
    build:
      context: ../..
      dockerfile: backend/services/api-gateway/Dockerfile
    container_name: otobia-api-gateway
    environment:
      NODE_ENV: production
      PORT: 8000
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      REDIS_URL: redis://otobia-redis:6379
      AUTH_SERVICE_URL: http://otobia-auth-service:3001
      GALLERY_SERVICE_URL: http://otobia-gallery-service:3002
      INVENTORY_SERVICE_URL: http://otobia-inventory-service:3003
      OFFER_SERVICE_URL: http://otobia-offer-service:3004
      CHAT_SERVICE_URL: http://otobia-chat-service:3005
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.otobia.com`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.services.api.loadbalancer.server.port=8000"
    networks:
      - otobia-network
    depends_on:
      - auth-service
      - gallery-service
      - inventory-service
    restart: unless-stopped

  # ==================== AUTH SERVICE ====================
  auth-service:
    build:
      context: ../..
      dockerfile: backend/services/auth-service/Dockerfile
    container_name: otobia-auth-service
    environment:
      NODE_ENV: production
      PORT: 3001
      DATABASE_URL: postgresql://otobia_user:otobia_password@otobia-postgres:5432/otobia_db
      REDIS_URL: redis://otobia-redis:6379
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      JWT_EXPIRES_IN: 7d
    networks:
      - otobia-network
    restart: unless-stopped

  # ==================== GALLERY SERVICE ====================
  gallery-service:
    build:
      context: ../..
      dockerfile: backend/services/gallery-service/Dockerfile
    container_name: otobia-gallery-service
    environment:
      NODE_ENV: production
      PORT: 3002
      DATABASE_URL: postgresql://otobia_user:otobia_password@otobia-postgres:5432/otobia_db
      REDIS_URL: redis://otobia-redis:6379
      RABBITMQ_URL: amqp://otobia_user:otobia_password@otobia-rabbitmq:5672/otobia
    networks:
      - otobia-network
    restart: unless-stopped

  # ==================== INVENTORY SERVICE ====================
  inventory-service:
    build:
      context: ../..
      dockerfile: backend/services/inventory-service/Dockerfile
    container_name: otobia-inventory-service
    environment:
      NODE_ENV: production
      PORT: 3003
      DATABASE_URL: postgresql://otobia_user:otobia_password@otobia-postgres:5432/otobia_db
      REDIS_URL: redis://otobia-redis:6379
      RABBITMQ_URL: amqp://otobia_user:otobia_password@otobia-rabbitmq:5672/otobia
      MEILISEARCH_URL: http://otobia-meilisearch:7700
      MEILISEARCH_API_KEY: ${MEILISEARCH_MASTER_KEY:-master_key_change_in_production}
      MINIO_ENDPOINT: otobia-minio
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
    networks:
      - otobia-network
    restart: unless-stopped

  # ==================== OFFER SERVICE ====================
  offer-service:
    build:
      context: ../..
      dockerfile: backend/services/offer-service/Dockerfile
    container_name: otobia-offer-service
    environment:
      NODE_ENV: production
      PORT: 3004
      DATABASE_URL: postgresql://otobia_user:otobia_password@otobia-postgres:5432/otobia_db
      REDIS_URL: redis://otobia-redis:6379
      RABBITMQ_URL: amqp://otobia_user:otobia_password@otobia-rabbitmq:5672/otobia
    networks:
      - otobia-network
    restart: unless-stopped

  # ==================== CHAT SERVICE ====================
  chat-service:
    build:
      context: ../..
      dockerfile: backend/services/chat-service/Dockerfile
    container_name: otobia-chat-service
    environment:
      NODE_ENV: production
      PORT: 3005
      DATABASE_URL: postgresql://otobia_user:otobia_password@otobia-postgres:5432/otobia_db
      REDIS_URL: redis://otobia-redis:6379
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.chat.rule=Host(`chat.otobia.com`)"
      - "traefik.http.routers.chat.entrypoints=websecure"
      - "traefik.http.routers.chat.tls.certresolver=letsencrypt"
      - "traefik.http.services.chat.loadbalancer.server.port=3005"
      # WebSocket sticky sessions for Socket.IO
      - "traefik.http.services.chat.loadbalancer.sticky.cookie=true"
      - "traefik.http.services.chat.loadbalancer.sticky.cookie.name=io"
      - "traefik.http.services.chat.loadbalancer.sticky.cookie.secure=true"
      - "traefik.http.services.chat.loadbalancer.sticky.cookie.httpOnly=true"
    networks:
      - otobia-network
    restart: unless-stopped

networks:
  otobia-network:
    external: true
